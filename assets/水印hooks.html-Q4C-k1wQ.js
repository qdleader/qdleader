import{_ as s,c as a,a as p,o as t}from"./app-D8HvJIFE.js";const e={};function o(l,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="水印hooks" tabindex="-1"><a class="header-anchor" href="#水印hooks"><span>水印hooks</span></a></h1><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">Ref</span><span class="token punctuation">,</span> onBeforeUnmount<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> debounce <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;lodash-es&quot;</span></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">Observer</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  watermarkElMutationObserver<span class="token operator">?</span><span class="token operator">:</span> MutationObserver</span>
<span class="line">  parentElMutationObserver<span class="token operator">?</span><span class="token operator">:</span> MutationObserver</span>
<span class="line">  parentElResizeObserver<span class="token operator">?</span><span class="token operator">:</span> ResizeObserver</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token doc-comment comment">/** 默认配置 */</span></span>
<span class="line"><span class="token keyword">const</span> defaultConfig <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token doc-comment comment">/** 防御（默认开启，能防御水印被删除或隐藏） */</span></span>
<span class="line">  defense<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 文本颜色 */</span></span>
<span class="line">  color<span class="token operator">:</span> <span class="token string">&quot;#c0c4cc&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 文本透明度 */</span></span>
<span class="line">  opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 文本字体大小 */</span></span>
<span class="line">  size<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 文本字体 */</span></span>
<span class="line">  family<span class="token operator">:</span> <span class="token string">&quot;serif&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 文本倾斜角度 */</span></span>
<span class="line">  angle<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 一处水印所占宽度（数值越大水印密度越低） */</span></span>
<span class="line">  width<span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token doc-comment comment">/** 一处水印所占高度（数值越大水印密度越低） */</span></span>
<span class="line">  height<span class="token operator">:</span> <span class="token number">200</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">DefaultConfig</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> defaultConfig</span>
<span class="line"><span class="token doc-comment comment">/** body 元素 */</span></span>
<span class="line"><span class="token keyword">const</span> bodyEl <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 创建水印</span>
<span class="line"> * 1. 可以选择传入挂载水印的容器元素，默认是 body</span>
<span class="line"> * 2. 做了水印防御，能有效防御别人打开控制台删除或隐藏水印</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useWatermark</span><span class="token punctuation">(</span>parentEl<span class="token operator">:</span> Ref<span class="token operator">&lt;</span>HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token operator">=</span> bodyEl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token doc-comment comment">/** 备份文本 */</span></span>
<span class="line">  <span class="token keyword">let</span> backupText<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token doc-comment comment">/** 最终配置 */</span></span>
<span class="line">  <span class="token keyword">let</span> mergeConfig<span class="token operator">:</span> DefaultConfig</span>
<span class="line">  <span class="token doc-comment comment">/** 水印元素 */</span></span>
<span class="line">  <span class="token keyword">let</span> watermarkEl<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token doc-comment comment">/** 观察器 */</span></span>
<span class="line">  <span class="token keyword">const</span> observer<span class="token operator">:</span> Observer <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    watermarkElMutationObserver<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">    parentElMutationObserver<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">    parentElResizeObserver<span class="token operator">:</span> <span class="token keyword">undefined</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 设置水印 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">setWatermark</span> <span class="token operator">=</span> <span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> config<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>DefaultConfig<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentEl<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;请在 DOM 挂载完成后再调用 setWatermark 方法设置水印&quot;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 备份文本</span></span>
<span class="line">    backupText <span class="token operator">=</span> text</span>
<span class="line">    <span class="token comment">// 合并配置</span></span>
<span class="line">    mergeConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultConfig<span class="token punctuation">,</span> <span class="token operator">...</span>config <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 创建或更新水印元素</span></span>
<span class="line">    watermarkEl <span class="token operator">?</span> <span class="token function">updateWatermarkEl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">createWatermarkEl</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 监听水印元素和容器元素的变化</span></span>
<span class="line">    <span class="token function">addElListener</span><span class="token punctuation">(</span>parentEl<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 创建水印元素 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">createWatermarkEl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> isBody <span class="token operator">=</span></span>
<span class="line">      parentEl<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span></span>
<span class="line">      bodyEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> watermarkElPosition <span class="token operator">=</span> isBody <span class="token operator">?</span> <span class="token string">&quot;fixed&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;absolute&quot;</span></span>
<span class="line">    <span class="token keyword">const</span> parentElPosition <span class="token operator">=</span> isBody <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;relative&quot;</span></span>
<span class="line">    watermarkEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>pointerEvents <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span></span>
<span class="line">    watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span></span>
<span class="line">    watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span></span>
<span class="line">    watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> watermarkElPosition</span>
<span class="line">    watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> <span class="token string">&quot;99999&quot;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> parentEl<span class="token punctuation">.</span>value<span class="token operator">!</span></span>
<span class="line">    <span class="token function">updateWatermarkEl</span><span class="token punctuation">(</span><span class="token punctuation">{</span> width<span class="token operator">:</span> clientWidth<span class="token punctuation">,</span> height<span class="token operator">:</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 设置水印容器为相对定位</span></span>
<span class="line">    parentEl<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> parentElPosition</span>
<span class="line">    <span class="token comment">// 将水印元素添加到水印容器中</span></span>
<span class="line">    parentEl<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>watermarkEl<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 更新水印元素 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">updateWatermarkEl</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    options<span class="token operator">:</span> Partial<span class="token operator">&lt;</span><span class="token punctuation">{</span></span>
<span class="line">      width<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">      height<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>watermarkEl<span class="token punctuation">)</span> <span class="token keyword">return</span></span>
<span class="line">    backupText <span class="token operator">&amp;&amp;</span></span>
<span class="line">      <span class="token punctuation">(</span>watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">url(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">createBase64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) left top repeat</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    options<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>options<span class="token punctuation">.</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    options<span class="token punctuation">.</span>height <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>watermarkEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>options<span class="token punctuation">.</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 创建 base64 图片 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">createBase64</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> color<span class="token punctuation">,</span> opacity<span class="token punctuation">,</span> size<span class="token punctuation">,</span> family<span class="token punctuation">,</span> angle<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> mergeConfig</span>
<span class="line">    <span class="token keyword">const</span> canvasEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    canvasEl<span class="token punctuation">.</span>width <span class="token operator">=</span> width</span>
<span class="line">    canvasEl<span class="token punctuation">.</span>height <span class="token operator">=</span> height</span>
<span class="line">    <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvasEl<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> color</span>
<span class="line">      ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> opacity</span>
<span class="line">      ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>family<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">      ctx<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> angle<span class="token punctuation">)</span></span>
<span class="line">      ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>backupText<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> canvasEl<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 清除水印 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">clearWatermark</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentEl<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token operator">!</span>watermarkEl<span class="token punctuation">)</span> <span class="token keyword">return</span></span>
<span class="line">    <span class="token comment">// 移除对水印元素和容器元素的监听</span></span>
<span class="line">    <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 移除水印元素</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      parentEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>watermarkEl<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 比如在无防御情况下，用户打开控制台删除了这个元素</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;水印元素已不存在，请重新创建&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">      watermarkEl <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 刷新水印（防御时调用） */</span></span>
<span class="line">  <span class="token keyword">const</span> updateWatermark <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">clearWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">createWatermarkEl</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">addElListener</span><span class="token punctuation">(</span>parentEl<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token doc-comment comment">/** 监听水印元素和容器元素的变化（DOM 变化 &amp; DOM 大小变化） */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">addElListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span>targetNode<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 判断是否开启防御</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeConfig<span class="token punctuation">.</span>defense<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 防止重复添加监听</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">!</span>observer<span class="token punctuation">.</span>watermarkElMutationObserver <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token operator">!</span>observer<span class="token punctuation">.</span>parentElMutationObserver</span>
<span class="line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 监听 DOM 变化</span></span>
<span class="line">        <span class="token function">addMutationListener</span><span class="token punctuation">(</span>targetNode<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 无防御时不需要 mutation 监听</span></span>
<span class="line">      <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">&quot;mutation&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 防止重复添加监听</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>observer<span class="token punctuation">.</span>parentElResizeObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 监听 DOM 大小变化</span></span>
<span class="line">      <span class="token function">addResizeListener</span><span class="token punctuation">(</span>targetNode<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 移除对水印元素和容器元素的监听，传参可指定要移除哪个监听，不传默认移除全部监听 */</span></span>
<span class="line">  <span class="token keyword">const</span> removeListener <span class="token operator">=</span> <span class="token punctuation">(</span>kind<span class="token operator">:</span> <span class="token string">&quot;mutation&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;resize&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;all&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 移除 mutation 监听</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">===</span> <span class="token string">&quot;mutation&quot;</span> <span class="token operator">||</span> kind <span class="token operator">===</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      observer<span class="token punctuation">.</span>watermarkElMutationObserver<span class="token operator">?.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      observer<span class="token punctuation">.</span>watermarkElMutationObserver <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">      observer<span class="token punctuation">.</span>parentElMutationObserver<span class="token operator">?.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      observer<span class="token punctuation">.</span>parentElMutationObserver <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 移除 resize 监听</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">===</span> <span class="token string">&quot;resize&quot;</span> <span class="token operator">||</span> kind <span class="token operator">===</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      observer<span class="token punctuation">.</span>parentElResizeObserver<span class="token operator">?.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      observer<span class="token punctuation">.</span>parentElResizeObserver <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token doc-comment comment">/** 监听 DOM 变化 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">addMutationListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span>targetNode<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 当观察到变动时执行的回调</span></span>
<span class="line">    <span class="token keyword">const</span> mutationCallback <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutationList<span class="token operator">:</span> MutationRecord<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 水印的防御（防止用户手动删除水印元素或通过 CSS 隐藏水印）</span></span>
<span class="line">      mutationList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token operator">:</span> MutationRecord<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">switch</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token string">&quot;attributes&quot;</span><span class="token operator">:</span></span>
<span class="line">              mutation<span class="token punctuation">.</span>target <span class="token operator">===</span> watermarkEl <span class="token operator">&amp;&amp;</span> <span class="token function">updateWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">              <span class="token keyword">break</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token string">&quot;childList&quot;</span><span class="token operator">:</span></span>
<span class="line">              mutation<span class="token punctuation">.</span>removedNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                item <span class="token operator">===</span> watermarkEl <span class="token operator">&amp;&amp;</span> targetNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>watermarkEl<span class="token punctuation">)</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">              <span class="token keyword">break</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 创建观察器实例并传入回调</span></span>
<span class="line">    observer<span class="token punctuation">.</span>watermarkElMutationObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span></span>
<span class="line">      mutationCallback</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    observer<span class="token punctuation">.</span>parentElMutationObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>mutationCallback<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 以上述配置开始观察目标节点</span></span>
<span class="line">    observer<span class="token punctuation">.</span>watermarkElMutationObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>watermarkEl<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 观察目标节点属性是否变动，默认为 true</span></span>
<span class="line">      attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token comment">// 观察目标子节点是否有添加或者删除，默认为 false</span></span>
<span class="line">      childList<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token comment">// 是否拓展到观察所有后代节点，默认为 false</span></span>
<span class="line">      subtree<span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    observer<span class="token punctuation">.</span>parentElMutationObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>targetNode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      attributes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      childList<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      subtree<span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/** 监听 DOM 大小变化 */</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">addResizeListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span>targetNode<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 当 targetNode 元素大小变化时去更新整个水印的大小</span></span>
<span class="line">    <span class="token keyword">const</span> resizeCallback <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> targetNode</span>
<span class="line">      <span class="token function">updateWatermarkEl</span><span class="token punctuation">(</span><span class="token punctuation">{</span> width<span class="token operator">:</span> clientWidth<span class="token punctuation">,</span> height<span class="token operator">:</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 创建一个观察器实例并传入回调</span></span>
<span class="line">    observer<span class="token punctuation">.</span>parentElResizeObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResizeObserver</span><span class="token punctuation">(</span>resizeCallback<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 开始观察目标节点</span></span>
<span class="line">    observer<span class="token punctuation">.</span>parentElResizeObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>targetNode<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/** 在组件卸载前移除水印以及各种监听 */</span></span>
<span class="line">  <span class="token function">onBeforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">clearWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> setWatermark<span class="token punctuation">,</span> clearWatermark <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h2><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useWatermark <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/hooks/useWatermark&quot;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> setWatermark<span class="token operator">:</span> setGlobalWatermark <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"> <span class="token function">setGlobalWatermark</span><span class="token punctuation">(</span><span class="token string">&quot;全局水印&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      color<span class="token operator">:</span> <span class="token string">&#39;#333&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      opacity<span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/hooks/%E6%B0%B4%E5%8D%B0hooks.html","title":"水印hooks","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1761877037000,"contributors":[{"name":"qdleader","username":"qdleader","email":"yk4545945@163.com","commits":1,"url":"https://github.com/qdleader"}],"changelog":[{"hash":"bd7640b59685e94edda53b9f6d34fbec27933dd4","time":1761877037000,"email":"yk4545945@163.com","author":"qdleader","message":"docs: 更新仓库链接和添加交流社区信息"}]},"filePathRelative":"hooks/水印hooks.md"}');export{i as comp,u as data};
